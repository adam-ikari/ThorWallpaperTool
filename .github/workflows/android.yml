name: Android CI/CD with AI Testing and iFlow CLI

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main" ]

jobs:
  iflow-analysis:
    name: iFlow CLI Analysis
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install iFlow CLI
      run: |
        pip install iflow-cli || echo "iFlow CLI not available as pip package, using alternative approach"
    
    - name: Run iFlow Analysis
      run: |
        # Check if iflow-cli is available
        if command -v iflow-cli &> /dev/null; then
          echo "Running iFlow CLI Analysis..."
          iflow-cli analyze --project-path . --output-path ./iflow-results
        else
          echo "iFlow CLI not available, creating placeholder results"
          mkdir -p iflow-results
          echo "iFlow analysis would run here if the tool was available" > iflow-results/analysis.txt
        fi
      continue-on-error: true

    - name: Upload iFlow Analysis Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: iflow-analysis-results
        path: iflow-results/

  test:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    needs: iflow-analysis

    steps:
    - uses: actions/checkout@v4
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Validate Gradle wrapper
      uses: gradle/wrapper-validation-action@v2

    - name: Run unit tests
      run: ./gradlew testDebugUnitTest

    - name: Run lint
      run: ./gradlew lintDebug

  ai-monkey-test:
    name: AI Monkey Test
    runs-on: macos-latest  # Use macOS runner for better Android emulator support
    needs: [iflow-analysis, test]
    timeout-minutes: 30

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Build Debug APK
      run: ./gradlew assembleDebug

    - name: Run AI Monkey Test
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 33
        target: google_apis
        arch: x86_64
        profile: Nexus 6
        script: |
          adb wait-for-device
          adb devices
          adb shell input keyevent 82
          
          # Install the APK
          adb install app/build/outputs/apk/debug/app-debug.apk
          
          # Run the AI Monkey test
          echo "Running AI Monkey Test..."
          adb shell monkey \
            --package com.adam.thorwallpapertool \
            --throttle 200 \
            --pct-touch 30 \
            --pct-motion 20 \
            --pct-trackball 10 \
            --pct-nav 10 \
            --pct-majornav 5 \
            --pct-syskeys 5 \
            --pct-appswitch 10 \
            --pct-anyevent 5 \
            --ignore-crashes \
            --ignore-timeouts \
            --ignore-security-exceptions \
            --ignore-native-crashes \
            --monitor-native-crashes \
            200

          # Collect logs
          adb logcat -d > monkey_test_logcat.log
          
    - name: Run AI Analysis
      run: |
        mkdir -p ai_monkey_results
        cp monkey_test_logcat.log ai_monkey_results/
        python3 scripts/ai_monkey_analyzer.py ai_monkey_results/
      continue-on-error: true  # Don't fail the job if AI analysis has issues

    - name: Upload AI Monkey Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ai-monkey-test-results
        path: ai_monkey_results/

  build:
    name: Build and Upload APK
    runs-on: ubuntu-latest
    needs: [iflow-analysis, test, ai-monkey-test]

    steps:
    - uses: actions/checkout@v4
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Validate Gradle wrapper
      uses: gradle/wrapper-validation-action@v2

    - name: Build debug APK
      run: ./gradlew assembleDebug

    - name: Build release APK (unsigned)
      run: ./gradlew assembleRelease -x validateSigning

    - name: Run all tests
      run: ./gradlew test

    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: debug-apk
        path: app/build/outputs/apk/debug/app-debug.apk

    - name: Upload Release APK
      uses: actions/upload-artifact@v4
      with:
        name: release-apk
        path: app/build/outputs/apk/release/app-release-unsigned.apk
